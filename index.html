<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Seguimiento de Apuestas</title>

<style>
:root {
  --bg: #f4f6f8;
  --card: #ffffff;
  --primary: #2563eb;
  --success: #16a34a;
  --danger: #dc2626;
  --text: #1f2937;
  --muted: #6b7280;
  --border: #d1d5db;
}

body.dark {
  --bg: #0f172a;
  --card: #020617;
  --primary: #3b82f6;
  --success: #22c55e;
  --danger: #ef4444;
  --text: #e5e7eb;
  --muted: #94a3b8;
  --border: #1e293b;
}
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  padding: 12px;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg);
  color: var(--text);
}

h2 {
  margin: 16px 0 8px;
  font-size: 1.1rem;
}

.card {
  background: var(--card);
  border-radius: 14px;
  padding: 14px;
  margin-bottom: 14px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.06);
}

label {
  font-size: 0.8rem;
  color: var(--muted);
  display: block;
  margin-top: 10px;
}

input, select {
  width: 100%;
  padding: 10px;
  margin-top: 4px;
  border-radius: 10px;
  border: 1px solid #d1d5db;
  font-size: 0.9rem;
}

input:focus, select:focus {
  outline: none;
  border-color: var(--primary);
}

button {
  width: 100%;
  padding: 12px;
  margin-top: 12px;
  border-radius: 12px;
  border: none;
  font-weight: 600;
  font-size: 0.95rem;
  background: var(--primary);
  color: white;
  cursor: pointer;
}

button:active {
  transform: scale(0.98);
}

.option {
  background: #f9fafb;
  border-radius: 12px;
  padding: 10px;
  margin-top: 10px;
}

details {
  margin-top: 10px;
}

summary {
  font-weight: 600;
  cursor: pointer;
  padding: 6px 0;
}

.win {
  color: var(--success);
  font-weight: 600;
}

.lose {
  color: var(--danger);
  font-weight: 600;
}

/* Desktop mejora */
@media (min-width: 768px) {
  body {
    max-width: 700px;
    margin: auto;
  }
}
  #stakeCalculator {
  margin-top: 20px;
}

#stakeCalculator p {
  margin-top: 10px;
  font-size: 14px;
}

</style>

</head>

<body>
<button id="toggleTheme">üåô Modo oscuro</button>

<h2>Registro de Apuestas</h2>
<label>Responsable</label>
<select id="responsable">
  <option value="Alex">Alex</option>
  <option value="Andres">Andr√©s</option>
</select>

<div class="card">
  <label>Ver banca de</label>
  <select id="filtroPersona" onchange="calcularBanca()">
    <option value="Alex">Alex</option>
    <option value="Andres">Andr√©s</option>
  </select>

  <label>Banca inicial (COP)</label>
  <input type="number" id="bancaInicial">
  <button onclick="guardarBanca()">üíæ Guardar banca</button>

  <p><strong>Banca actual:</strong> $<span id="bancaActual">0</span></p>
  <p><strong>Promedio de stake:</strong> $<span id="promedioStake">0</span></p>
</div>

<div class="card" id="stakeCalculator">
  <h3>üìä Calculadora de Stake</h3>

  <label>Banca actual</label>
  <input type="number" id="bancaCalc" placeholder="Ej: 100000">

  <label>Cuota</label>
  <input type="number" step="0.01" id="cuotaCalc" placeholder="Ej: 1.85">

  <button type="button" onclick="calcularStakeUI()">
    Calcular apuesta
  </button>

  <p id="resultadoStake"></p>
</div>

<div class="card">
  <label>Tipo</label>
  <select id="tipo">
    <option>Simple</option>
    <option>Combinada</option>
  </select>

  <label>Stake</label>
  <input type="number" id="stake">

  <label>Cuota Total</label>
  <input type="number" id="cuota" step="0.01">

  <button onclick="agregarOpcion()">‚ûï Agregar Opci√≥n</button>
  <div id="opciones"></div>

  <button onclick="guardarApuesta()">üíæ Guardar Apuesta</button>
</div>

<h2>Historial</h2>
<div id="historial"></div>
<script type="module">
/* =========================
   FIREBASE
========================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  updateDoc,
  doc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBtOk-otWrGU7ljda52yhVhSvQKaG3siRM",
  authDomain: "apuestas-analisis.firebaseapp.com",
  projectId: "apuestas-analisis",
  storageBucket: "apuestas-analisis.firebasestorage.app",
  messagingSenderId: "542021066839",
  appId: "1:542021066839:web:bb6a43f578a39d07c68312"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* =========================
   VARIABLES
========================= */
window.opcionesTemp = [];

/* =========================
   AGREGAR OPCI√ìN
========================= */
window.agregarOpcion = function () {
  const i = opcionesTemp.length;
  opcionesTemp.push({ partido:'', mercado:'', estado:'Pendiente', motivo:'' });

  const div = document.createElement('div');
  div.className = 'option';
  div.innerHTML = `
    <input placeholder="Partido" oninput="opcionesTemp[${i}].partido=this.value">
    <input placeholder="Mercado / Opci√≥n" oninput="opcionesTemp[${i}].mercado=this.value">
    <select onchange="opcionesTemp[${i}].estado=this.value">
      <option>Pendiente</option>
      <option>Ganada</option>
      <option>Perdida</option>
    </select>
    <input placeholder="Motivo" oninput="opcionesTemp[${i}].motivo=this.value">
  `;
  document.getElementById('opciones').appendChild(div);
};

/* =========================
   GUARDAR APUESTA (FIREBASE)
========================= */
window.guardarApuesta = async function () {
  const apuesta = {
    fecha: new Date().toLocaleDateString(),
    hora: new Date().toLocaleTimeString(),
    responsable: document.getElementById('responsable').value,
    tipo: document.getElementById('tipo').value,
    stake: Number(document.getElementById('stake').value),
    cuota: Number(document.getElementById('cuota').value),
    opciones: opcionesTemp
  };

  await addDoc(collection(db, "apuestas"), apuesta);

  opcionesTemp = [];
  document.getElementById('opciones').innerHTML = '';
  cargarHistorial();
  calcularBanca();
};

/* =========================
   HISTORIAL DESPLEGABLE
========================= */
window.cargarHistorial = async function () {
  const cont = document.getElementById('historial');
  cont.innerHTML = '';

  const snap = await getDocs(collection(db, "apuestas"));
  const apuestas = [];

  snap.forEach(d => apuestas.push({ id: d.id, ...d.data() }));

  const porFecha = {};
  apuestas.forEach(a => {
    if (!porFecha[a.fecha]) porFecha[a.fecha] = [];
    porFecha[a.fecha].push(a);
  });

  Object.keys(porFecha).forEach(fecha => {
    let html = `<details class="card"><summary>üìÖ ${fecha}</summary>`;

    porFecha[fecha].forEach(a => {
      html += `<details style="margin-left:15px">
        <summary>üë§ ${a.responsable} | ${a.tipo} | Stake ${a.stake}</summary>`;

      a.opciones.forEach((o, i) => {
        html += `
          <div class="option">
            <b>${o.partido}</b><br>
            ${o.mercado}<br>
            <select onchange="actualizarOpcion('${a.id}',${i},this.value)">
              <option ${o.estado==='Pendiente'?'selected':''}>Pendiente</option>
              <option ${o.estado==='Ganada'?'selected':''}>Ganada</option>
              <option ${o.estado==='Perdida'?'selected':''}>Perdida</option>
            </select>
          </div>`;
      });

      html += `</details>`;
    });

    html += `</details>`;
    cont.innerHTML += html;
  });
};

/* =========================
   ACTUALIZAR OPCI√ìN
========================= */
window.actualizarOpcion = async function (apuestaId, index, estado) {
  const ref = doc(db, "apuestas", apuestaId);
  const snap = await getDocs(collection(db, "apuestas"));

  snap.forEach(async d => {
    if (d.id === apuestaId) {
      const data = d.data();
      data.opciones[index].estado = estado;
      await updateDoc(ref, { opciones: data.opciones });
      calcularBanca();
    }
  });
};

/* =========================
   BANCA POR PERSONA (LOCAL)
========================= */
window.guardarBanca = function () {
  const persona = document.getElementById('filtroPersona').value;
  const banca = Number(document.getElementById('bancaInicial').value);
  const bancas = JSON.parse(localStorage.getItem('bancas')) || {};
  bancas[persona] = banca;
  localStorage.setItem('bancas', JSON.stringify(bancas));
  calcularBanca();
};

window.calcularBanca = function () {
  const persona = document.getElementById('filtroPersona').value;
  const bancas = JSON.parse(localStorage.getItem('bancas')) || {};
  let banca = bancas[persona] || 0;

  getDocs(collection(db, "apuestas")).then(snap => {
    snap.forEach(d => {
      const a = d.data();
      if (a.responsable !== persona) return;
      if (a.opciones.some(o => o.estado === 'Pendiente')) return;

      if (a.opciones.some(o => o.estado === 'Perdida')) {
        banca -= a.stake;
      } else {
        banca += (a.stake * a.cuota) - a.stake;
      }
    });

    document.getElementById('bancaActual').innerText = banca.toFixed(0);
  });
};

/* =========================
   MODO OSCURO
========================= */
const btn = document.getElementById("toggleTheme");
if (localStorage.getItem("theme") === "dark") {
  document.body.classList.add("dark");
  btn.textContent = "‚òÄÔ∏è Modo claro";
}
btn.addEventListener("click", () => {
  document.body.classList.toggle("dark");
  const d = document.body.classList.contains("dark");
  localStorage.setItem("theme", d ? "dark" : "light");
  btn.textContent = d ? "‚òÄÔ∏è Modo claro" : "üåô Modo oscuro";
});

/* INIT */
cargarHistorial();
calcularBanca();
  function obtenerStakePorcentaje(cuota) {
  if (cuota <= 1.5) return 1;
  if (cuota <= 1.8) return 1.5;
  if (cuota <= 2.2) return 2;
  if (cuota <= 3) return 2.5;
  return 3;
}

function calcularApuesta(banca, cuota) {
  const stakePorcentaje = obtenerStakePorcentaje(cuota);
  let apuesta = (banca * stakePorcentaje) / 100;

  if (apuesta < 500) apuesta = 500;

  return {
    apuesta: Math.round(apuesta),
    stakePorcentaje
  };
}

window.calcularStakeUI = function () {
  const banca = Number(document.getElementById('bancaCalc').value);
  const cuota = Number(document.getElementById('cuotaCalc').value);
  const out = document.getElementById('resultadoStake');

  if (!banca || !cuota) {
    out.innerText = '‚ö†Ô∏è Ingresa banca y cuota';
    return;
  }

  const { apuesta, stakePorcentaje } = calcularApuesta(banca, cuota);
  const stakeReal = ((apuesta / banca) * 100).toFixed(2);

  out.innerHTML = `
    üí∞ Apuesta sugerida: <b>$${apuesta}</b><br>
    üéØ Stake sugerido: <b>${stakePorcentaje}%</b><br>
    üìä Stake real: <b>${stakeReal}%</b>
  `;
};

</script>



</body>
</html>
