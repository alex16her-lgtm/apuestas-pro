<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Seguimiento de Apuestas</title>
<script>
  // Ocultar admin ANTES de renderizar
  if (localStorage.getItem("isAdmin") !== "true") {
    document.write('<style>#adminPanel{display:none!important}</style>');
  }
</script>

<style>
:root {
  --bg: #f4f6f8;
  --card: #ffffff;
  --primary: #2563eb;
  --success: #16a34a;
  --danger: #dc2626;
  --text: #1f2937;
  --muted: #6b7280;
  --border: #d1d5db;
}

body.dark {
  --bg: #0f172a;
  --card: #020617;
  --primary: #3b82f6;
  --success: #22c55e;
  --danger: #ef4444;
  --text: #e5e7eb;
  --muted: #94a3b8;
  --border: #1e293b;
}
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  padding: 12px;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: var(--bg);
  color: var(--text);
}

h2 {
  margin: 16px 0 8px;
  font-size: 1.1rem;
}

.card {
  background: var(--card);
  border-radius: 14px;
  padding: 14px;
  margin-bottom: 14px;
  box-shadow: 0 6px 20px rgba(0,0,0,0.06);
}

label {
  font-size: 0.8rem;
  color: var(--muted);
  display: block;
  margin-top: 10px;
}

input, select {
  width: 100%;
  padding: 10px;
  margin-top: 4px;
  border-radius: 10px;
  border: 1px solid #d1d5db;
  font-size: 0.9rem;
}

input:focus, select:focus {
  outline: none;
  border-color: var(--primary);
}

button {
  width: 100%;
  padding: 12px;
  margin-top: 12px;
  border-radius: 12px;
  border: none;
  font-weight: 600;
  font-size: 0.95rem;
  background: var(--primary);
  color: white;
  cursor: pointer;
}

button:active {
  transform: scale(0.98);
}

.option {
  background: #f9fafb;
  border-radius: 12px;
  padding: 10px;
  margin-top: 10px;
}

details {
  margin-top: 10px;
}

summary {
  font-weight: 600;
  cursor: pointer;
  padding: 6px 0;
}

.win {
  color: var(--success);
  font-weight: 600;
}

.lose {
  color: var(--danger);
  font-weight: 600;
}

/* Desktop mejora */
@media (min-width: 768px) {
  body {
    max-width: 700px;
    margin: auto;
  }
}
  #stakeCalculator {
  margin-top: 20px;
}

#stakeCalculator p {
  margin-top: 10px;
  font-size: 14px;
}

</style>

</head>

<body>
<button id="toggleTheme">ğŸŒ™ Modo oscuro</button>

<h2>Registro de Apuestas</h2>
<label>Responsable</label>
<select id="responsable">
  <option value="Alex">Alex</option>
  <option value="Andres">AndrÃ©s</option>
</select>

<div class="card">
  <label>Ver banca de</label>
  <select id="filtroPersona" onchange="calcularBanca()">
    <option value="Alex">Alex</option>
    <option value="Andres">AndrÃ©s</option>
  </select>

  <label>Banca inicial (COP)</label>
  <input type="number" id="bancaInicial" id="stake">
  <button onclick="guardarBanca()">ğŸ’¾ Guardar banca</button>

  <p><strong>Banca actual:</strong> $<span id="bancaActual">0</span></p>
  <p><strong>Promedio de stake:</strong> $<span id="promedioStake">0</span></p>
</div>

<div class="card">
  <h3>ğŸ¯ Calculadora de Stake</h3>

  <input
    id="cuotaCalc"
    type="number"
    step="0.01"
    placeholder="Cuota"
    oninput="calcularStakeAutomatico()"
  />

  <select id="modoRiesgo" onchange="calcularStakeAutomatico()">
    <option value="conservador">ğŸŸ¢ Conservador</option>
    <option value="normal" selected>ğŸŸ¡ Normal</option>
    <option value="agresivo">ğŸ”´ Agresivo</option>
  </select>

  <p>
    Stake sugerido:
    <b id="stakeSugerido">â€”</b>
  </p>

  <button onclick="copiarStakeAlFormulario()">
    ğŸ“‹ Usar este stake
  </button>
</div>



<div class="card">
  <label>Tipo</label>
  <select id="tipo">
    <option>Simple</option>
    <option>Combinada</option>
  </select>

  <label>Dinero $</label>
  <input type="number" id="stake">

  <label>Cuota Total</label>
  <input type="number" id="cuota" step="0.01">

  <button onclick="agregarOpcion()">â• Agregar OpciÃ³n</button>
  <div id="opciones"></div>

  <button onclick="guardarApuesta()">ğŸ’¾ Guardar Apuesta</button>
</div>

<h2>Historial</h2>
<div id="historial"></div>
  <button onclick="loginAdmin()">ğŸ” Admin</button>

<div id="adminPanel">
  <button onclick="borrarDatos()" style="background:red;color:white">
    ğŸ—‘ï¸ Borrar TODAS las apuestas
  </button>
</div>


<script type="module">
  window.ADMIN_KEY = "rayo";
/* =========================
   FIREBASE
========================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  updateDoc,
  doc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBtOk-otWrGU7ljda52yhVhSvQKaG3siRM",
  authDomain: "apuestas-analisis.firebaseapp.com",
  projectId: "apuestas-analisis",
  storageBucket: "apuestas-analisis.firebasestorage.app",
  messagingSenderId: "542021066839",
  appId: "1:542021066839:web:bb6a43f578a39d07c68312"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* =========================
   VARIABLES
========================= */
window.opcionesTemp = [];

/* =========================
   AGREGAR OPCIÃ“N
========================= */
window.agregarOpcion = function () {
  const i = opcionesTemp.length;
  opcionesTemp.push({ partido:'', mercado:'', estado:'Pendiente', motivo:'' });

  const div = document.createElement('div');
  div.className = 'option';
  div.innerHTML = `
    <input placeholder="Partido" oninput="opcionesTemp[${i}].partido=this.value">
    <input placeholder="Mercado / OpciÃ³n" oninput="opcionesTemp[${i}].mercado=this.value">
    <select onchange="opcionesTemp[${i}].estado=this.value">
      <option>Pendiente</option>
      <option>Ganada</option>
      <option>Perdida</option>
    </select>
    <input placeholder="Motivo" oninput="opcionesTemp[${i}].motivo=this.value">
  `;
  document.getElementById('opciones').appendChild(div);
};

/* =========================
   GUARDAR APUESTA (FIREBASE)
========================= */
window.guardarApuesta = async function () {
  const apuesta = {
    fecha: new Date().toLocaleDateString(),
    hora: new Date().toLocaleTimeString(),
    responsable: document.getElementById('responsable').value,
    tipo: document.getElementById('tipo').value,
    stake: Number(document.getElementById('stake').value),
    cuota: Number(document.getElementById('cuota').value),
    opciones: opcionesTemp
  };

  await addDoc(collection(db, "apuestas"), apuesta);

  opcionesTemp = [];
  document.getElementById('opciones').innerHTML = '';
  cargarHistorial();
  calcularBanca();
};

/* =========================
   HISTORIAL DESPLEGABLE
========================= */
window.cargarHistorial = async function () {
  const cont = document.getElementById('historial');
  cont.innerHTML = '';

  const snap = await getDocs(collection(db, "apuestas"));
  const apuestas = [];

  snap.forEach(d => apuestas.push({ id: d.id, ...d.data() }));

  const porFecha = {};
  apuestas.forEach(a => {
    if (!porFecha[a.fecha]) porFecha[a.fecha] = [];
    porFecha[a.fecha].push(a);
  });

  Object.keys(porFecha).forEach(fecha => {
    let html = `<details class="card"><summary>ğŸ“… ${fecha}</summary>`;

    porFecha[fecha].forEach(a => {
      html += `<details style="margin-left:15px">
        <summary>ğŸ‘¤ ${a.responsable} | ${a.tipo} | Stake ${a.stake}</summary>`;

      a.opciones.forEach((o, i) => {
        html += `
          <div class="option">
            <b>${o.partido}</b><br>
            ${o.mercado}<br>
            <select onchange="actualizarOpcion('${a.id}',${i},this.value)">
              <option ${o.estado==='Pendiente'?'selected':''}>Pendiente</option>
              <option ${o.estado==='Ganada'?'selected':''}>Ganada</option>
              <option ${o.estado==='Perdida'?'selected':''}>Perdida</option>
            </select>
          </div>`;
      });

      html += `</details>`;
    });

    html += `</details>`;
    cont.innerHTML += html;
  });
};

/* =========================
   ACTUALIZAR OPCIÃ“N
========================= */
window.actualizarOpcion = async function (apuestaId, index, estado) {
  const ref = doc(db, "apuestas", apuestaId);
  const snap = await getDocs(collection(db, "apuestas"));

  snap.forEach(async d => {
    if (d.id === apuestaId) {
      const data = d.data();
      data.opciones[index].estado = estado;
      await updateDoc(ref, { opciones: data.opciones });
      calcularBanca();
    }
  });
};

/* =========================
   BANCA POR PERSONA (LOCAL)
========================= */
window.guardarBanca = function () {
  const persona = document.getElementById('filtroPersona').value;
  const banca = Number(document.getElementById('bancaInicial').value);
  const bancas = JSON.parse(localStorage.getItem('bancas')) || {};
  bancas[persona] = banca;
  localStorage.setItem('bancas', JSON.stringify(bancas));
  calcularBanca();
};

window.calcularBanca = function () {
  const persona = document.getElementById('filtroPersona').value;
  const bancas = JSON.parse(localStorage.getItem('bancas')) || {};
  let banca = bancas[persona] || 0;

  getDocs(collection(db, "apuestas")).then(snap => {
    snap.forEach(d => {
      const a = d.data();
      if (a.responsable !== persona) return;
      if (a.opciones.some(o => o.estado === 'Pendiente')) return;

      if (a.opciones.some(o => o.estado === 'Perdida')) {
        banca -= a.stake;
      } else {
        banca += (a.stake * a.cuota) - a.stake;
      }
    });

    document.getElementById('bancaActual').innerText = banca.toFixed(0);
  });
};

/* =========================
   MODO OSCURO
========================= */
const btn = document.getElementById("toggleTheme");
if (localStorage.getItem("theme") === "dark") {
  document.body.classList.add("dark");
  btn.textContent = "â˜€ï¸ Modo claro";
}
btn.addEventListener("click", () => {
  document.body.classList.toggle("dark");
  const d = document.body.classList.contains("dark");
  localStorage.setItem("theme", d ? "dark" : "light");
  btn.textContent = d ? "â˜€ï¸ Modo claro" : "ğŸŒ™ Modo oscuro";
});

/* INIT */
cargarHistorial();
calcularBanca();
 function obtenerStakePorcentaje(cuota) {
  if (cuota <= 1.5) return 3;
  if (cuota <= 1.8) return 2.5;
  if (cuota <= 2.2) return 2;
  if (cuota <= 3) return 1.5;
  return 1;
}


function calcularApuesta(banca, cuota) {
  const stakePorcentaje = obtenerStakePorcentaje(cuota);
  let apuesta = (banca * stakePorcentaje) / 100;

  if (apuesta < 500) apuesta = 500;

  return {
    apuesta: Math.round(apuesta),
    stakePorcentaje
  };
}

window.calcularStakeUI = function () {
  const banca = Number(document.getElementById('bancaCalc').value);
  const cuota = Number(document.getElementById('cuotaCalc').value);
  const out = document.getElementById('resultadoStake');

  if (!banca || !cuota) {
    out.innerText = 'âš ï¸ Ingresa banca y cuota';
    return;
  }

  const { apuesta, stakePorcentaje } = calcularApuesta(banca, cuota);
  const stakeReal = ((apuesta / banca) * 100).toFixed(2);

  out.innerHTML = `
    ğŸ’° Apuesta sugerida: <b>$${apuesta}</b><br>
    ğŸ¯ Stake sugerido: <b>${stakePorcentaje}%</b><br>
    ğŸ“Š Stake real: <b>${stakeReal}%</b>
  `;
};
window.calcularStakeAutomatico = function () {
  const cuota = Number(document.getElementById("cuotaCalc").value);
  if (!cuota || cuota <= 1) return;

  const bancaActual = Number(
    document.getElementById("bancaActual").innerText
  );
  if (!bancaActual || bancaActual <= 0) return;

  let porcentaje = obtenerStakePorcentaje(cuota);

  const modo = document.getElementById("modoRiesgo").value;
  if (modo === "conservador") porcentaje -= 0.5;
  if (modo === "agresivo") porcentaje += 0.5;

  // lÃ­mites de seguridad
  if (porcentaje < 0.5) porcentaje = 0.5;
  if (porcentaje > 4) porcentaje = 4;

  let stake = bancaActual * (porcentaje / 100);

  if (stake < 500) stake = 500;

  // guardamos stake calculado para copiarlo luego
  window.stakeCalculado = stake.toFixed(0);

  document.getElementById("stakeSugerido").innerText =
    `$${stake.toFixed(0)} (${porcentaje}%)`;
};

  window.copiarStakeAlFormulario = function () {
  if (!window.stakeCalculado) return;
  document.getElementById("stake").value = window.stakeCalculado;
};

window.loginAdmin = function () {
  const pass = prompt("Clave de administrador:");
  if (pass === ADMIN_KEY) {
    localStorage.setItem("isAdmin", "true");
    document.getElementById("adminPanel").style.display = "block";
    alert("Modo admin activado âœ…");
  } else {
    alert("Clave incorrecta âŒ");
  }
};

window.borrarDatos = async function () {
  if (localStorage.getItem("isAdmin") !== "true") return;

  if (!confirm("âš ï¸ Esto borrarÃ¡ TODAS las apuestas. Â¿Seguro?")) return;

  const snap = await getDocs(collection(db, "apuestas"));
  for (const d of snap.docs) {
    await deleteDoc(doc(db, "apuestas", d.id));
  }

  alert("Datos eliminados âœ…");
  cargarHistorial();
  calcularBanca();
};
const adminPanel = document.getElementById("adminPanel");
if (localStorage.getItem("isAdmin") === "true") {
  adminPanel.style.display = "block";
} else {
  adminPanel.style.display = "none";
}




</script>



</body>
</html>
