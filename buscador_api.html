<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Buscador API - F√∫tbol Profesional</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --bg:#0f172a;
  --card:#1e293b;
  --text:#f8fafc;
  --accent:#22c55e;
  --danger:#ef4444;
  --border:#334155;
}

*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:'Segoe UI', system-ui, sans-serif;
  padding: 20px;
}

.container{ max-width: 800px; margin: auto; }

h1 { text-align: center; color: var(--accent); margin-bottom: 20px; }

.search-box {
  display: flex; gap: 10px; background: var(--card);
  padding: 15px; border-radius: 12px; border: 1px solid var(--border);
  margin-bottom: 20px;
}

input {
  flex: 1; padding: 12px; border-radius: 8px; border: 1px solid var(--border);
  background: #0f172a; color: white;
}

button { padding: 12px 20px; border-radius: 8px; border: none; font-weight: bold; cursor: pointer; }
.btn-search { background: var(--accent); color: #022c22; }
.btn-update { background: #3b82f6; color: white; padding: 4px 8px; font-size: 11px; }
.btn-delete { background: #475569; color: #f87171; padding: 4px 8px; font-size: 11px; margin-left: 5px;}
.btn-players { background: transparent; border: 1px dashed var(--accent); color: var(--accent); width: 100%; margin-top: 15px; padding: 10px; }

/* Estilo Lista Desplegable (Acorde√≥n) */
.team-card {
  background: var(--card);
  margin-top: 10px;
  border-radius: 12px;
  border: 1px solid var(--border);
  overflow: hidden;
}

summary {
  padding: 15px;
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
  list-style: none;
  background: #0f172a;
}
summary::-webkit-details-marker { display: none; }

.stats-grid {
  display: grid; grid-template-columns: repeat(5, 1fr);
  gap: 1px; background: var(--border); text-align: center;
}

.stat-item { background: var(--card); padding: 10px; }
.stat-label { font-size: 9px; color: #94a3b8; text-transform: uppercase; }
.stat-value { font-size: 16px; font-weight: bold; color: white; }

.table { width: 100%; border-collapse: collapse; font-size: 12px; }
.table th { background: #0f172a; color: #94a3b8; padding: 8px; }
.table td { padding: 8px; text-align: center; border-bottom: 1px solid #334155; }

/* Jugadores */
.players-container {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 10px; margin-top: 15px; padding: 10px; background: #020617; border-radius: 8px;
}
.player-mini-card { text-align: center; font-size: 11px; padding: 5px; }
.player-mini-card img { width: 40px; border-radius: 50%; border: 1px solid var(--accent); }

.spinner { text-align: center; padding: 10px; color: var(--accent); font-weight: bold; }
</style>
</head>
<body>

<div class="container">
  <h1>‚öΩ Buscador & Historial API</h1>
  
  <div class="search-box">
    <input type="text" id="teamInput" placeholder="Nombre del equipo..." onkeypress="if(event.key==='Enter') buscarEquipo()">
    <button class="btn-search" onclick="buscarEquipo()">üîç BUSCAR</button>
  </div>

  <div id="loadingStatus"></div>
  <div id="resultsArea"></div>

  <button style="background:var(--border); color:white; width:100%; margin-top:20px" onclick="window.location.href='analisis.html'">‚¨Ö Volver al Equipos HvsH</button>
</div>

<script src="dataService.js"></script>

<script>
// 1. ESCUCHAR HISTORIAL (Persistencia al recargar)
db.collection("cache_equipos").orderBy("updated", "desc").onSnapshot(snap => {
    const container = document.getElementById("resultsArea");
    container.innerHTML = "";
    
    if(snap.empty) {
        container.innerHTML = "<p style='text-align:center; color:#64748b'>Historial vac√≠o.</p>";
        return;
    }

    snap.forEach(doc => {
        const data = doc.data();
        container.innerHTML += renderTeamCard(data.team, data.partidos, doc.id, data.jugadores);
    });
});

// 2. BUSCAR EQUIPO
async function buscarEquipo(forceUpdate = false) {
  const teamName = document.getElementById("teamInput").value.trim();
  if(!teamName) return alert("Escribe un nombre de equipo");

  document.getElementById("loadingStatus").innerHTML = `<div class="spinner">‚è≥ Procesando ${teamName}...</div>`;
  
  await getTeamData(teamName, forceUpdate);
  
  document.getElementById("loadingStatus").innerHTML = "";
  document.getElementById("teamInput").value = "";
}

// 3. CARGAR JUGADORES (BAJO DEMANDA)
// 3. ACTUALIZAR JUGADORES (BAJO DEMANDA)
async function verJugadores(nombre) {
    console.log("Iniciando b√∫squeda de jugadores para:", nombre);
    const btn = event.target; // Capturamos el bot√≥n que pulsaste
    const textoOriginal = btn.innerText;
    
    btn.innerText = "‚è≥ Buscando cracks...";
    btn.disabled = true;

    try {
        // Llamada a la funci√≥n en dataService.js
        await getTopPlayers(nombre);
        console.log("Jugadores guardados con √©xito");
        // No hace falta hacer nada m√°s, el onSnapshot redibujar√° la tarjeta sola
    } catch (e) {
        console.error("Error al obtener jugadores:", e);
        alert("Hubo un problema con la API. Intenta en un minuto.");
        btn.innerText = textoOriginal;
        btn.disabled = false;
    }
}

// 4. ELIMINAR DEL HISTORIAL
async function eliminarHistorial(id) {
    if(confirm("¬øEliminar este equipo del historial?")) {
        await db.collection("cache_equipos").doc(id).delete();
    }
}

// 5. RENDERIZAR TARJETA (Acorde√≥n)
function renderTeamCard(nombre, partidos, docId, jugadores = []) {
  const n = partidos.length;
  // Usamos el docId de Firebase para identificar la tarjeta de forma √∫nica
  const idSafe = docId; 
  const avg = stat => (partidos.reduce((a,p) => a + (p.stats[stat]||0), 0) / n).toFixed(1);

  // 1. Generar filas de la tabla
  const rows = partidos.map(p => {
    const fecha = new Date(p.fecha).toLocaleDateString('es-ES', {day:'2-digit', month:'2-digit'});
    const esLocal = p.local ? '<b style="color:#fbbf24">L</b>' : '<span style="color:#94a3b8">V</span>';
    
    return `
    <tr>
      <td>${fecha}</td>
      <td style="text-align:left">${esLocal} vs ${p.rival}</td>
      <td>${p.stats.tt}</td>
      <td>${p.stats.tap}</td>
      <td>${p.stats.cor}</td>
      <td>${p.stats.tar}</td>
      <td style="color:var(--accent); font-weight:bold">${p.stats.gol}</td>
    </tr>`;
  }).join("");

  // 2. L√≥gica de Jugadores (Solo se muestra si ya existen en Firebase)
  let jugadoresHTML = "";
  if (jugadores && jugadores.length > 0) {
      jugadoresHTML = `
      <div style="margin-top:20px; border-top:1px solid var(--border); padding-top:15px">
        <h4 style="color:#fbbf24; font-size:14px; margin-bottom:10px">‚≠ê Jugadores a Seguir</h4>
        <div class="players-container" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(120px, 1fr)); gap:10px">
          ${jugadores.map(j => `
            <div class="player-mini-card" style="background:#0f172a; padding:10px; border-radius:10px; text-align:center">
              <img src="${j.foto}" style="width:45px; border-radius:50%; border:1px solid var(--accent)">
              <div style="font-weight:bold; font-size:11px; margin-top:5px; white-space:nowrap; overflow:hidden">${j.nombre}</div>
              <div style="color:var(--accent); font-size:10px">Rating: ${j.rating} | G: ${j.goles}</div>
            </div>`).join("")}
        </div>
      </div>`;
  } else {
      // Si no hay jugadores, mostramos el bot√≥n que gasta API
      jugadoresHTML = `
      <button id="btn-${idSafe}" class="btn-players" onclick="verJugadores('${nombre}')" style="width:100%; margin-top:15px; cursor:pointer">
        üë• Ver Jugadores Clave (Gasta API)
      </button>`;
  }

  // 3. Estructura del Acorde√≥n
  return `
  <div class="team-card" id="card-${idSafe}">
    <details>
      <summary>
        <div style="display:flex; align-items:center; gap:10px">
            <span style="font-size:18px">‚öΩ</span> 
            <b>${nombre}</b> 
            <span style="font-size:11px; color:var(--accent)">Avg Goles: ${avg("gol")}</span>
        </div>
        <div onclick="event.preventDefault()">
            <button class="btn-update" onclick="getTeamData('${nombre}', true)">üîÑ</button>
            <button class="btn-delete" onclick="eliminarHistorial('${docId}')">üóëÔ∏è</button>
        </div>
      </summary>

      <div class="stats-content" style="padding:15px; background:#020617">
        <div class="stats-grid">
          <div class="stat-item"><div class="stat-label">Tiros</div><div class="stat-value">${avg("tt")}</div></div>
          <div class="stat-item"><div class="stat-label">A Puerta</div><div class="stat-value">${avg("tap")}</div></div>
          <div class="stat-item"><div class="stat-label">Corners</div><div class="stat-value">${avg("cor")}</div></div>
          <div class="stat-item"><div class="stat-label">Tarjetas</div><div class="stat-value" style="color:var(--danger)">${avg("tar")}</div></div>
          <div class="stat-item"><div class="stat-label">Goles</div><div class="stat-value" style="color:var(--accent)">${avg("gol")}</div></div>
        </div>

        <table class="table">
          <thead>
            <tr><th>Fecha</th><th>Rival</th><th>TT</th><th>AP</th><th>COR</th><th>T</th><th>G</th></tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>

        ${jugadoresHTML}
      </div>
    </details>
  </div>`;
}
</script>
</body>
</html>
