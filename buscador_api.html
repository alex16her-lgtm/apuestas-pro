<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Historial Maestro - API F√∫tbol</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
    :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --accent: #22c55e; --border: #334155; }
    body { margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; padding: 20px; }
    .container { max-width: 700px; margin: auto; }
    
    /* Buscador */
    .search-box { display: flex; gap: 10px; background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 25px; border: 1px solid var(--border); }
    input { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: #020617; color: white; }
    button.btn-search { background: var(--accent); color: #064e3b; border: none; padding: 0 20px; border-radius: 8px; font-weight: bold; cursor: pointer; }

    /* Estilo Lista Desplegable */
    .team-item { background: var(--card); border: 1px solid var(--border); border-radius: 10px; margin-bottom: 10px; }
    summary { padding: 15px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
    summary:hover { background: #334155; }
    
    .actions { display: flex; gap: 8px; }
    .btn-act { padding: 5px 10px; border-radius: 5px; border: none; cursor: pointer; font-size: 12px; font-weight: bold; }
    .upd { background: #3b82f6; color: white; }
    .del { background: #475569; color: #f87171; }

    .content { padding: 15px; background: #020617; border-top: 1px solid var(--border); }
    .stats-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 15px; text-align: center; }
    .box { background: #1e293b; padding: 8px; border-radius: 8px; }
    .box label { font-size: 9px; color: #94a3b8; display: block; }
    .box b { font-size: 16px; }

    .table { width: 100%; border-collapse: collapse; font-size: 12px; }
    .table th { color: #64748b; padding-bottom: 8px; }
    .table td { padding: 8px 4px; border-bottom: 1px solid #1e293b; text-align: center; }

    .player-chip { background: #1e293b; padding: 8px; border-radius: 8px; display: flex; align-items: center; gap: 10px; margin-top: 5px; }
    .player-chip img { width: 30px; border-radius: 50%; }

    .loading { text-align: center; color: var(--accent); margin-bottom: 15px; font-weight: bold; }
</style>
</head>
<body>

<div class="container">
    <h2>üìä Buscador & Historial API</h2>

    <div class="search-box">
        <input type="text" id="teamInput" placeholder="Nombre del equipo..." onkeypress="if(event.key==='Enter') buscarEquipo()">
        <button class="btn-search" onclick="buscarEquipo()">BUSCAR</button>
    </div>

    <div id="status" class="loading"></div>
    <div id="results"></div>
    
    <button onclick="window.location.href='analisis.html'" style="width:100%; padding:12px; margin-top:20px; background:var(--border); color:white; border:none; border-radius:8px; cursor:pointer;">‚¨Ö Volver a H2H Manual</button>
</div>

<script src="dataService.js"></script>

<script>
// 1. CARGAR HISTORIAL AUTOM√ÅTICAMENTE
// Escuchamos la colecci√≥n "cache_equipos" (sin importar la versi√≥n del nombre)
db.collection("cache_equipos").orderBy("updated", "desc").onSnapshot(snap => {
    const res = document.getElementById("results");
    res.innerHTML = "";
    
    if(snap.empty) {
        res.innerHTML = "<p style='text-align:center; color:#64748b'>No hay equipos buscados a√∫n.</p>";
        return;
    }

    snap.forEach(doc => {
        const data = doc.data();
        res.innerHTML += renderAccordion(data.team, data.partidos, doc.id, data.jugadores);
    });
});

// 2. BUSCAR
async function buscarEquipo() {
    const name = document.getElementById("teamInput").value.trim();
    if(!name) return;
    
    document.getElementById("status").innerText = `‚è≥ Buscando ${name}...`;
    await getTeamData(name, false);
    document.getElementById("status").innerText = "";
    document.getElementById("teamInput").value = "";
}

// 3. ACTUALIZAR JUGADORES (BAJO DEMANDA)
async function verJugadores(nombre) {
    document.getElementById("status").innerText = `üë• Obteniendo cracks de ${nombre}...`;
    await getTopPlayers(nombre);
    document.getElementById("status").innerText = "";
}

// 4. ACTUALIZAR PARTIDOS
async function forzar(nombre) {
    document.getElementById("status").innerText = `üîÑ Actualizando partidos de ${nombre}...`;
    await getTeamData(nombre, true);
    document.getElementById("status").innerText = "";
}

// 5. BORRAR
async function borrar(id) {
    if(confirm("¬øEliminar del historial?")) await db.collection("cache_equipos").doc(id).delete();
}

// RENDERIZADO
function renderAccordion(nombre, partidos, docId, jugadores = []) {
    const n = partidos.length;
    const avg = s => (partidos.reduce((a,p)=>a+(p.stats[s]||0),0)/n).toFixed(1);

    const rows = partidos.map(p => `
        <tr>
            <td>${new Date(p.fecha).toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit'})}</td>
            <td style="text-align:left">${p.local?'L':'V'} vs ${p.rival}</td>
            <td>${p.stats.tt}</td><td>${p.stats.cor}</td><td>${p.stats.tar}</td>
            <td style="color:#4ade80; font-weight:bold">${p.stats.gol}</td>
        </tr>`).join("");

    let playersHTML = "";
    if(jugadores && jugadores.length > 0) {
        playersHTML = `<div style="margin-top:15px; color:#fbbf24; font-size:13px">‚≠ê Jugadores clave:</div>` + 
            jugadores.map(j => `
            <div class="player-chip">
                <img src="${j.foto}">
                <span><b>${j.nombre}</b> (Rating: ${j.rating})</span>
            </div>`).join("");
    } else {
        playersHTML = `<button onclick="verJugadores('${nombre}')" style="width:100%; margin-top:10px; background:#1e293b; color:#94a3b8; border:1px dashed #334155; padding:8px; border-radius:8px; cursor:pointer">üë• Cargar Jugadores Clave</button>`;
    }

    return `
    <details class="team-item">
        <summary>
            <span>‚öΩ ${nombre}</span>
            <div class="actions">
                <button class="btn-act upd" onclick="event.stopPropagation(); forzar('${nombre}')">üîÑ</button>
                <button class="btn-act del" onclick="event.stopPropagation(); borrar('${docId}')">üóëÔ∏è</button>
            </div>
        </summary>
        <div class="content">
            <div class="stats-grid">
                <div class="box"><label>TIROS</label><b>${avg("tt")}</b></div>
                <div class="box"><label>CORNERS</label><b>${avg("cor")}</b></div>
                <div class="box"><label>TARJ</label><b style="color:#f87171">${avg("tar")}</b></div>
                <div class="box"><label>GOLES</label><b style="color:#4ade80">${avg("gol")}</b></div>
            </div>
            <table class="table">
                <thead><tr><th>Fecha</th><th>Rival</th><th>TT</th><th>C</th><th>T</th><th>G</th></tr></thead>
                <tbody>${rows}</tbody>
            </table>
            ${playersHTML}
        </div>
    </details>`;
}
</script>
</body>
</html>
