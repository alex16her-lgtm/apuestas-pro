<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>An√°lisis de Partidos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --bg:#0f172a;
  --card:#020617;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --border:#1e293b;
  --accent:#22c55e;
}

*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui;
}
.container{max-width:1200px;margin:auto;padding:16px}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:12px;
  padding:16px;
  margin-bottom:16px;
}
input,button{
  background:#020617;
  color:var(--text);
  border:1px solid var(--border);
  border-radius:8px;
  padding:8px;
  width:100%;
}
button{
  background:var(--accent);
  color:#022c22;
  font-weight:700;
  cursor:pointer;
}
.grid{
  display:grid;
  gap:8px;
  grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
}
.table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
}
.table th,.table td{
  border:1px solid var(--border);
  padding:6px;
  text-align:center;
}
.table th{color:var(--muted)}
.small{font-size:11px;color:var(--muted)}
@media(max-width:600px){
  .table{font-size:10px}
}
  .prob{
  font-weight: bold;
  padding: 4px 8px;
  border-radius: 6px;
  display: inline-block;
  font-size: 0.9rem;
}

.prob.green{
  background: #d4f7dc;
  color: #1b7a2f;
}

.prob.yellow{
  background: #fff3cd;
  color: #856404;
}

.prob.red{
  background: #f8d7da;
  color: #842029;
}
.prob.green{ color:#22c55e; font-weight:700 }
.prob.yellow{ color:#eab308; font-weight:700 }
.prob.red{ color:#ef4444; font-weight:700 }
.recs {
  margin-top: 12px;
  background: #111;
  padding: 10px;
  border-radius: 8px;
}

.recs ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.recs li {
  display: flex;
  justify-content: space-between;
  padding: 6px 8px;
  border-bottom: 1px solid #333;
  color: #ddd;
}

.recs li:last-child {
  border-bottom: none;
}

.top-pick {
  background: linear-gradient(90deg, #1e7f43, #2ecc71);
  color: #fff;
  font-weight: bold;
  border-radius: 6px;
}

.confianza {
  font-size: 0.9em;
  opacity: 0.9;
}

</style>
</head>

<body>
  
<div class="container">
<h2>üìä An√°lisis de enfrentamientos</h2>
<!-- PARTIDO -->
<div class="card">
<h2>Partido </h2>
<div class="grid">
<input id="teamA" placeholder="Equipo A">
<input id="teamB" placeholder="Equipo B">
</div>
</div>

<!-- ENCUENTRO -->
<div class="card">
<h3>Agregar Encuentro</h3>
<div class="grid">
<input id="competencia" placeholder="Competencia">
<select id="equipoLocal">
  <option value="">Local (general)</option>
  <option value="A">Equipo A es LOCAL</option>
  <option value="B">Equipo B es LOCAL</option>
</select>
  
<input id="ttA" placeholder="Tiros Totales A">
<input id="ttB" placeholder="Tiros Totales B">

<input id="tapA" placeholder="A Puerta A">
<input id="tapB" placeholder="A Puerta B">

<input id="corA" placeholder="Corners A">
<input id="corB" placeholder="Corners B">

<input id="tarA" placeholder="Tarjetas A">
<input id="tarB" placeholder="Tarjetas B">

<input id="golA" placeholder="Goles A">
<input id="golB" placeholder="Goles B">
</div>
<br>
<button onclick="addMatch()">A√ëADIR ENCUENTRO</button>
</div>

<!-- HISTORIAL -->
<div class="card">
<h3>Historial</h3>
<div id="historial"></div>
<table class="table" id="tabla">
<thead>
<tr>
<th>Partido</th>
<th>Competencia</th>
<th>TT (A|B)</th>
<th>AP (A|B)</th>
<th>COR (A|B)</th>
<th>TAR (A|B)</th>
<th>GOL (A|B)</th>
</tr>
</thead>
<tbody></tbody>
<tfoot>
<tr><th colspan="2">TOTAL</th>
<th id="t1"></th><th id="t2"></th><th id="t3"></th><th id="t4"></th><th id="t5"></th></tr>
<tr><th colspan="2">PROMEDIO</th>
<th id="p1"></th><th id="p2"></th><th id="p3"></th><th id="p4"></th><th id="p5"></th></tr>
<tr><th colspan="2">PROBABILIDAD</th>
<th id="pr1"></th><th id="pr2"></th><th id="pr3"></th><th id="pr4"></th><th id="pr5"></th></tr>
</tfoot>
</table>



</div>
<div class="card" style="text-align:left">
  <button onclick="irApuestas()">‚¨ÖÔ∏è Volver a Apuestas</button>
</div>
<div class="card" style="text-align:left">
  <button onclick="irEquipos()">üìä Analisis de equipos</button>
</div>
</div>
<script>
// üî• Firebase
const firebaseConfig = {
  apiKey: "AIzaSyBtOk-otWrGU7ljda52yhVhSvQKaG3siRM",
  authDomain: "apuestas-analisis.firebaseapp.com",
  projectId: "apuestas-analisis",
  storageBucket: "apuestas-analisis.firebasestorage.app",
  messagingSenderId: "542021066839",
  appId: "1:542021066839:web:bb6a43f578a39d07c68312"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const ref = db.collection("equipos");

// ===============================
// UTILIDADES
// ===============================
function normalizar(texto) {
  if (!texto || typeof texto !== "string") return "";
  return texto
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .toLowerCase()
    .trim();
}

function overUnder(valorTotal, linea) {
  if (isNaN(valorTotal)) return "-";
  return valorTotal > linea ? `OVER ${linea}` : `UNDER ${linea}`;
}

// ===============================
// AGREGAR ENCUENTRO
// ===============================
async function addMatch() {
  const equipoA = teamA.value.trim();
  const equipoB = teamB.value.trim();

  if (!equipoA || !equipoB) {
    alert("Debes ingresar ambos equipos");
    return;
  }

  const campos = [ttA, ttB, tapA, tapB, corA, corB, tarA, tarB, golA, golB];
  for (let c of campos) {
    if (c.value === "" || isNaN(c.value)) {
      alert("Todos los campos num√©ricos deben estar completos");
      return;
    }
  }

  const encuentro = {
    competencia: competencia.value || "N/A",
    stats: {
      tt:  { A: Number(ttA.value),  B: Number(ttB.value)  },
      tap: { A: Number(tapA.value), B: Number(tapB.value) },
      cor: { A: Number(corA.value), B: Number(corB.value) },
      tar: { A: Number(tarA.value), B: Number(tarB.value) },
      gol: { A: Number(golA.value), B: Number(golB.value) }
    }
  };

  const q = await ref
    .where("equipoA", "==", equipoA)
    .where("equipoB", "==", equipoB)
    .limit(1)
    .get();

  if (q.empty) {
    await ref.add({
      equipoA,
      equipoB,
      equipoA_norm: normalizar(equipoA),
      equipoB_norm: normalizar(equipoB),
      encuentros: [encuentro],
      creado: firebase.firestore.FieldValue.serverTimestamp()
    });
  } else {
    const doc = q.docs[0];
    const data = doc.data();
    const encuentros = Array.isArray(data.encuentros) ? data.encuentros : [];
    await ref.doc(doc.id).update({
      encuentros: [...encuentros, encuentro]
    });
  }

  alert("‚úÖ Encuentro guardado correctamente");
}

// ===============================
// PROBABILIDAD
// ===============================
function probOverUnder(encuentros, stat, linea) {
  let over = 0;
  let under = 0;

  encuentros.forEach(e => {
    const total = e.stats[stat].A + e.stats[stat].B;
    total > linea ? over++ : under++;
  });

  const n = encuentros.length || 1;
  const pOver = Math.round((over / n) * 100);
  const pUnder = Math.round((under / n) * 100);

  const pick = pOver >= pUnder ? "OVER" : "UNDER";
  const pct = Math.max(pOver, pUnder);

  let color = "red";
  if (pct >= 65) color = "green";
  else if (pct >= 55) color = "yellow";

  return `<span class="prob ${color}">${pick} ${linea} (${pct}%)</span>`;
}

// ===============================
// RECOMENDACIONES (MEJOR PICK)
// ===============================
function generarRecomendaciones(encuentros) {
  if (!Array.isArray(encuentros) || encuentros.length < 3) {
    return [{ texto: "üìâ Datos insuficientes", confianza: 0 }];
  }

  const tot = { gol:0, cor:0, tar:0, tt:0 };
  encuentros.forEach(e => {
    tot.gol += e.stats.gol.A + e.stats.gol.B;
    tot.cor += e.stats.cor.A + e.stats.cor.B;
    tot.tar += e.stats.tar.A + e.stats.tar.B;
    tot.tt  += e.stats.tt.A  + e.stats.tt.B;
  });

  const n = encuentros.length;
  const avg = {
    gol: tot.gol / n,
    cor: tot.cor / n,
    tar: tot.tar / n,
    tt:  tot.tt  / n
  };

  function conf(media, linea) {
    return Math.min(95, Math.round(50 + Math.abs(media - linea) * 20));
  }

  const picks = [
    { texto: avg.gol >= 2.5 ? "‚öΩ Over 2.5 goles" : "‚öΩ Under 2.5 goles", confianza: conf(avg.gol,2.5) },
    { texto: avg.cor >= 9 ? "üö© Over 8.5 corners" : "üö© Under 8.5 corners", confianza: conf(avg.cor,8.5) },
    { texto: avg.tar >= 4 ? "üü® Over 3.5 tarjetas" : "üü® Under 3.5 tarjetas", confianza: conf(avg.tar,3.5) },
    { texto: avg.tt  >= 20 ? "üéØ Over 19.5 tiros" : "üéØ Under 19.5 tiros", confianza: conf(avg.tt,19.5) }
  ];

  picks.sort((a,b) => b.confianza - a.confianza);
  return picks;
}

// ===============================
// HISTORIAL
// ===============================
ref.onSnapshot(snapshot => {
  const h = document.getElementById("historial");
  h.innerHTML = "";

  snapshot.forEach(doc => {
    const m = doc.data();
    if (!m.equipoA || !m.equipoB) return;

    const encuentros = m.encuentros || [];
    if (!encuentros.length) return;

    let tot = { tt:0, tap:0, cor:0, tar:0, gol:0 };
    let totA = { tt:0, tap:0, cor:0, tar:0, gol:0 };
    let totB = { tt:0, tap:0, cor:0, tar:0, gol:0 };
    let filas = "";

    encuentros.forEach(e => {
      const s = e.stats;

      tot.tt  += s.tt.A + s.tt.B;
      tot.tap += s.tap.A + s.tap.B;
      tot.cor += s.cor.A + s.cor.B;
      tot.tar += s.tar.A + s.tar.B;
      tot.gol += s.gol.A + s.gol.B;

      totA.tt += s.tt.A; totA.tap += s.tap.A; totA.cor += s.cor.A; totA.tar += s.tar.A; totA.gol += s.gol.A;
      totB.tt += s.tt.B; totB.tap += s.tap.B; totB.cor += s.cor.B; totB.tar += s.tar.B; totB.gol += s.gol.B;

      filas += `
        <tr>
          <td>${m.equipoA} vs ${m.equipoB}</td>
          <td>${e.competencia}</td>
          <td>${s.tt.A}|${s.tt.B}</td>
          <td>${s.tap.A}|${s.tap.B}</td>
          <td>${s.cor.A}|${s.cor.B}</td>
          <td>${s.tar.A}|${s.tar.B}</td>
          <td>${s.gol.A}|${s.gol.B}</td>
        </tr>`;
    });

    const n = encuentros.length;
    const mejorPick = generarRecomendaciones(encuentros)[0];

    h.innerHTML += `
    <details class="card">
      <summary>‚öΩ ${m.equipoA} vs ${m.equipoB} (${n} encuentros)</summary>

      <div class="best-pick">
        üî• <b>Mejor pick:</b> ${mejorPick.texto}
        <span class="confianza">(${mejorPick.confianza}%)</span>
      </div>

      <table class="table">
        <thead>
          <tr>
            <th>Partido</th><th>Competencia</th>
            <th>TT</th><th>AP</th><th>COR</th><th>TAR</th><th>GOL</th>
          </tr>
        </thead>
        <tbody>${filas}</tbody>
        <tfoot>
          <tr><th colspan="2">TOTAL</th><th>${tot.tt}</th><th>${tot.tap}</th><th>${tot.cor}</th><th>${tot.tar}</th><th>${tot.gol}</th></tr>
          <tr><th colspan="2">PROMEDIO</th>
            <th>${(tot.tt/n).toFixed(1)}</th>
            <th>${(tot.tap/n).toFixed(1)}</th>
            <th>${(tot.cor/n).toFixed(1)}</th>
            <th>${(tot.tar/n).toFixed(1)}</th>
            <th>${(tot.gol/n).toFixed(1)}</th>
          </tr>
          <tr>
            <td colspan="2"><b>PROBABILIDAD</b></td>
            <td>${probOverUnder(encuentros,"tt",24.5)}</td>
            <td>${probOverUnder(encuentros,"tap",5.5)}</td>
            <td>${probOverUnder(encuentros,"cor",7.5)}</td>
            <td>${probOverUnder(encuentros,"tar",2.5)}</td>
            <td>${probOverUnder(encuentros,"gol",2.5)}</td>
          </tr>
        </tfoot>
      </table>
    </details>`;
  });
});
</script>



</body>
</html>
