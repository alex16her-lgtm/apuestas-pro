<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>An√°lisis de Partidos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --bg:#0f172a;
  --card:#020617;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --border:#1e293b;
  --accent:#22c55e;
}

*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui;
}
.container{max-width:1200px;margin:auto;padding:16px}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:12px;
  padding:16px;
  margin-bottom:16px;
}
input,button{
  background:#020617;
  color:var(--text);
  border:1px solid var(--border);
  border-radius:8px;
  padding:8px;
  width:100%;
}
button{
  background:var(--accent);
  color:#022c22;
  font-weight:700;
  cursor:pointer;
}
.grid{
  display:grid;
  gap:8px;
  grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
}
.table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
}
.table th,.table td{
  border:1px solid var(--border);
  padding:6px;
  text-align:center;
}
.table th{color:var(--muted)}
.small{font-size:11px;color:var(--muted)}
@media(max-width:600px){
  .table{font-size:10px}
}
  .prob{
  font-weight: bold;
  padding: 4px 8px;
  border-radius: 6px;
  display: inline-block;
  font-size: 0.9rem;
}

.prob.green{
  background: #d4f7dc;
  color: #1b7a2f;
}

.prob.yellow{
  background: #fff3cd;
  color: #856404;
}

.prob.red{
  background: #f8d7da;
  color: #842029;
}
.prob.green{ color:#22c55e; font-weight:700 }
.prob.yellow{ color:#eab308; font-weight:700 }
.prob.red{ color:#ef4444; font-weight:700 }

</style>
</head>

<body>
  
<div class="container">
<h2>üìä An√°lisis de enfrentamientos</h2>
<!-- PARTIDO -->
<div class="card">
<h2>Partido </h2>
<div class="grid">
<input id="teamA" placeholder="Equipo A">
<input id="teamB" placeholder="Equipo B">
</div>
</div>

<!-- ENCUENTRO -->
<div class="card">
<h3>Agregar Encuentro</h3>
<div class="grid">
<input id="competencia" placeholder="Competencia">
<select id="equipoLocal">
  <option value="">Local (general)</option>
  <option value="A">Equipo A es LOCAL</option>
  <option value="B">Equipo B es LOCAL</option>
</select>
  
<input id="ttA" placeholder="Tiros Totales A">
<input id="ttB" placeholder="Tiros Totales B">

<input id="tapA" placeholder="A Puerta A">
<input id="tapB" placeholder="A Puerta B">

<input id="corA" placeholder="Corners A">
<input id="corB" placeholder="Corners B">

<input id="tarA" placeholder="Tarjetas A">
<input id="tarB" placeholder="Tarjetas B">

<input id="golA" placeholder="Goles A">
<input id="golB" placeholder="Goles B">
</div>
<br>
<button onclick="addMatch()">A√ëADIR ENCUENTRO</button>
</div>

<!-- HISTORIAL -->
<div class="card">
<h3>Historial</h3>
<div id="historial"></div>
<table class="table" id="tabla">
<thead>
<tr>
<th>Partido</th>
<th>Competencia</th>
<th>TT (A|B)</th>
<th>AP (A|B)</th>
<th>COR (A|B)</th>
<th>TAR (A|B)</th>
<th>GOL (A|B)</th>
</tr>
</thead>
<tbody></tbody>
<tfoot>
<tr><th colspan="2">TOTAL</th>
<th id="t1"></th><th id="t2"></th><th id="t3"></th><th id="t4"></th><th id="t5"></th></tr>
<tr><th colspan="2">PROMEDIO</th>
<th id="p1"></th><th id="p2"></th><th id="p3"></th><th id="p4"></th><th id="p5"></th></tr>
<tr><th colspan="2">PROBABILIDAD</th>
<th id="pr1"></th><th id="pr2"></th><th id="pr3"></th><th id="pr4"></th><th id="pr5"></th></tr>
</tfoot>
</table>
</div>
<div class="card" style="text-align:left">
  <button onclick="irApuestas()">‚¨ÖÔ∏è Volver a Apuestas</button>
</div>
<div class="card" style="text-align:left">
  <button onclick="irEquipos()">üìä Analisis de equipos</button>
</div>
  <section class="card">
  <h2>üìä Forma reciente por equipo (√∫ltimos 10)</h2>

  <div id="formaEquipos">
    <p class="muted">Cargando datos‚Ä¶</p>
  </div>
</section>
</div>
<script src="dataService.js"></script>
<script>
  
function overUnder(valorTotal, linea){
  if (isNaN(valorTotal)) return "-";
  return valorTotal > linea
    ? `OVER ${linea}`
    : `UNDER ${linea}`;
}

// agregar encuentro
async function addMatch() {
  const equipoA = teamA.value.trim();
  const equipoB = teamB.value.trim();

  if (!equipoA || !equipoB) {
    alert("Faltan equipos");
    return;
  }

  const encuentro = {
    competencia: competencia.value,
    local: equipoLocal.value, // "A" o "B
    stats: {
      tt:{A:+ttA.value,B:+ttB.value},
      tap:{A:+tapA.value,B:+tapB.value},
      cor:{A:+corA.value,B:+corB.value},
      tar:{A:+tarA.value,B:+tarB.value},
      gol:{A:+golA.value,B:+golB.value}
    }
  };

  // buscar si ya existe ese an√°lisis
  const q = await ref
    .where("equipoA","==",equipoA)
    .where("equipoB","==",equipoB)
    .get();

  if (q.empty) {
    await ref.add({
      equipoA,
      equipoB,
      encuentros:[encuentro],
      creado: firebase.firestore.FieldValue.serverTimestamp()
    });
  } else {
    const doc = q.docs[0];
    await ref.doc(doc.id).update({
      encuentros: firebase.firestore.FieldValue.arrayUnion(encuentro)
    });
  }
}
 
  function probOverUnder(encuentros, stat, linea){
  let over = 0;
  let under = 0;

  encuentros.forEach(e => {
    const s = e.stats;
    const total = s[stat].A + s[stat].B;
    if (total > linea) over++;
    else under++;
  });

  const totalPartidos = encuentros.length || 1;
  const pOver  = Math.round((over / totalPartidos) * 100);
  const pUnder = Math.round((under / totalPartidos) * 100);

  const pick   = pOver >= pUnder ? "OVER" : "UNDER";
  const pct    = Math.max(pOver, pUnder);

  let color = "red";
  if (pct > 65) color = "green";
  else if (pct >= 55) color = "yellow";

  return `
    <span class="prob ${color}">
      ${pick} ${linea} (${pct}%)
    </span>
  `;
}
const ref = window.refAnalisis;
ref.onSnapshot(snapshot => {
  const h = document.getElementById("historial");
  h.innerHTML = "";

  snapshot.forEach(doc => {
    const m = doc.data();
    const encuentros = m.encuentros || [];
    const localElegido = document.getElementById("equipoLocal")?.value || null;
    

// encuentros seg√∫n contexto
const encuentrosContexto = localElegido
  ? filtrarPorLocal(encuentros, localElegido)
  : encuentros;

// fallback inteligente
const dataProb = encuentrosContexto.length >= 3
  ? encuentrosContexto
  : encuentros;

    let tot = {
      tt: 0, tap: 0, cor: 0, tar: 0, gol: 0
    };
let totA = { tt:0, tap:0, cor:0, tar:0, gol:0 };
let totB = { tt:0, tap:0, cor:0, tar:0, gol:0 };
    let filas = "";

    encuentros.forEach(e => {
      const s = e.stats;

      tot.tt  += s.tt.A  + s.tt.B;
      tot.tap += s.tap.A + s.tap.B;
      tot.cor += s.cor.A + s.cor.B;
      tot.tar += s.tar.A + s.tar.B;
      tot.gol += s.gol.A + s.gol.B;
// Equipo A
totA.tt  += s.tt.A;
totA.tap += s.tap.A;
totA.cor += s.cor.A;
totA.tar += s.tar.A;
totA.gol += s.gol.A;

// Equipo B
totB.tt  += s.tt.B;
totB.tap += s.tap.B;
totB.cor += s.cor.B;
totB.tar += s.tar.B;
totB.gol += s.gol.B;
          
      filas += `
        <tr>
          <td>${m.equipoA} vs ${m.equipoB}</td>
          <td>${e.competencia}</td>
          <td>${s.tt.A}|${s.tt.B}</td>
          <td>${s.tap.A}|${s.tap.B}</td>
          <td>${s.cor.A}|${s.cor.B}</td>
          <td>${s.tar.A}|${s.tar.B}</td>
          <td>${s.gol.A}|${s.gol.B}</td>
        </tr>
      `;
    });

    const n = encuentros.length || 1;

    h.innerHTML += `
    <details class="card">
      <summary>‚öΩ ${m.equipoA} vs ${m.equipoB} (${encuentros.length} encuentros)</summary>

      <table class="table">
        <thead>
          <tr>
            <th>Partido</th>
            <th>Competencia</th>
            <th>TT (A|B)</th>
            <th>AP (A|B)</th>
            <th>COR (A|B)</th>
            <th>TAR (A|B)</th>
            <th>GOL (A|B)</th>
          </tr>
        </thead>

        <tbody>
          ${filas}
        </tbody>

        <tfoot>
          <tr>
            <th colspan="2">TOTAL</th>
            <th>${tot.tt}</th>
            <th>${tot.tap}</th>
            <th>${tot.cor}</th>
            <th>${tot.tar}</th>
            <th>${tot.gol}</th>
          </tr>

          <tr>
            <th colspan="2">PROMEDIO</th>
            <th>${(tot.tt/n).toFixed(1)}</th>
            <th>${(tot.tap/n).toFixed(1)}</th>
            <th>${(tot.cor/n).toFixed(1)}</th>
            <th>${(tot.tar/n).toFixed(1)}</th>
            <th>${(tot.gol/n).toFixed(1)}</th>
          </tr>
<tr>
  <th colspan="2">PROM ${m.equipoA}</th>
  <th>${(totA.tt/n).toFixed(1)}</th>
  <th>${(totA.tap/n).toFixed(1)}</th>
  <th>${(totA.cor/n).toFixed(1)}</th>
  <th>${(totA.tar/n).toFixed(1)}</th>
  <th>${(totA.gol/n).toFixed(1)}</th>
</tr>
<tr>
  <th colspan="2">PROM ${m.equipoB}</th>
  <th>${(totB.tt/n).toFixed(1)}</th>
  <th>${(totB.tap/n).toFixed(1)}</th>
  <th>${(totB.cor/n).toFixed(1)}</th>
  <th>${(totB.tar/n).toFixed(1)}</th>
  <th>${(totB.gol/n).toFixed(1)}</th>
</tr>

          <tr>
  <td colspan="2"><b>PROBABILIDAD</b></td>
<td>${probOverUnder(dataProb,"tt",24.5)}</td>
<td>${probOverUnder(dataProb,"tap",5.5)}</td>
<td>${probOverUnder(dataProb,"cor",7.5)}</td>
<td>${probOverUnder(dataProb,"tar",2.5)}</td>
<td>${probOverUnder(dataProb,"gol",2.5)}</td>


</tr>

        </tfoot>
      </table>
    </details>`;
  });
  analizarFormaEquipos();
});
 

  function filtrarPorLocal(encuentros, local){
  return encuentros.filter(e => e.local === local);
}
function irApuestas(){
  window.location.href = "index.html";
}
function irEquipos(){
  window.location.href = "equipos.html";
}
  async function analizarFormaEquipos(){
  const equipoA = teamA.value.trim();
  const equipoB = teamB.value.trim();
 const ligaId = 10; // fijo por ahora, no afecta nada


  if(!equipoA || !equipoB) return;

  const cont = document.getElementById("formaEquipos");
  cont.innerHTML = "‚è≥ Analizando √∫ltimos partidos‚Ä¶";

  // üî• API + cache
  const dataA = await getTeamData(equipoA, ligaId);
  const dataB = await getTeamData(equipoB, ligaId);

  cont.innerHTML = `
    ${renderEquipo(equipoA, dataA)}
    ${renderEquipo(equipoB, dataB)}
  `;
}
  function renderEquipo(nombre, partidos){
  if(!partidos.length){
    return `<p>‚ùå Sin datos para ${nombre}</p>`;
  }

  const n = partidos.length;

  const avg = stat =>
    (partidos.reduce((a,p)=>a+(p.stats[stat]||0),0)/n).toFixed(1);

  const prob = (stat, linea) => {
    let over=0;
    partidos.forEach(p=>{
      if((p.stats[stat]||0) > linea) over++;
    });
    const pct = Math.round((over/n)*100);

    let c="red";
    if(pct>65) c="green";
    else if(pct>=55) c="yellow";

    return `<span class="prob ${c}">${pct}%</span>`;
  };

  return `
  <div class="card mini">
    <h3>‚öΩ ${nombre}</h3>

    <table class="table">
      <thead>
        <tr>
          <th>Stat</th>
          <th>Prom</th>
          <th>Prob</th>
        </tr>
      </thead>
      <tbody>
        <tr><td>TT</td><td>${avg("tt")}</td><td>${prob("tt",10)}</td></tr>
        <tr><td>AP</td><td>${avg("tap")}</td><td>${prob("tap",4)}</td></tr>
        <tr><td>COR</td><td>${avg("cor")}</td><td>${prob("cor",4.5)}</td></tr>
        <tr><td>TAR</td><td>${avg("tar")}</td><td>${prob("tar",3.5)}</td></tr>
        <tr><td>GOL</td><td>${avg("gol")}</td><td>${prob("gol",1.5)}</td></tr>
      </tbody>
    </table>
  </div>
  `;
}


</script>


</body>
</html>
