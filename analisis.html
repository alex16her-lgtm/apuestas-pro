<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>An√°lisis de Partidos</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --bg:#0f172a;
  --card:#020617;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --border:#1e293b;
  --accent:#22c55e;
}

*{box-sizing:border-box}
body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui;
}
.container{max-width:1200px;margin:auto;padding:16px}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:12px;
  padding:16px;
  margin-bottom:16px;
}
input,button{
  background:#020617;
  color:var(--text);
  border:1px solid var(--border);
  border-radius:8px;
  padding:8px;
  width:100%;
}
button{
  background:var(--accent);
  color:#022c22;
  font-weight:700;
  cursor:pointer;
}
.grid{
  display:grid;
  gap:8px;
  grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
}
.table{
  width:100%;
  border-collapse:collapse;
  font-size:12px;
}
.table th,.table td{
  border:1px solid var(--border);
  padding:6px;
  text-align:center;
}
.table th{color:var(--muted)}
.small{font-size:11px;color:var(--muted)}
@media(max-width:600px){
  .table{font-size:10px}
}
  .prob{
  font-weight: bold;
  padding: 4px 8px;
  border-radius: 6px;
  display: inline-block;
  font-size: 0.9rem;
}

.prob.green{
  background: #d4f7dc;
  color: #1b7a2f;
}

.prob.yellow{
  background: #fff3cd;
  color: #856404;
}

.prob.red{
  background: #f8d7da;
  color: #842029;
}
.prob.green{ color:#22c55e; font-weight:700 }
.prob.yellow{ color:#eab308; font-weight:700 }
.prob.red{ color:#ef4444; font-weight:700 }
.recs {
  margin-top: 12px;
  background: #111;
  padding: 10px;
  border-radius: 8px;
}

.recs ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.recs li {
  display: flex;
  justify-content: space-between;
  padding: 6px 8px;
  border-bottom: 1px solid #333;
  color: #ddd;
}

.recs li:last-child {
  border-bottom: none;
}

.top-pick {
  background: linear-gradient(90deg, #1e7f43, #2ecc71);
  color: #fff;
  font-weight: bold;
  border-radius: 6px;
}

.confianza {
  font-size: 0.9em;
  opacity: 0.9;
}

</style>
</head>

<body>
  
<div class="container">
<h2>üìä An√°lisis de enfrentamientos</h2>
<!-- PARTIDO -->
<div class="card">
<h2>Partido </h2>
<div class="grid">
<input id="teamA" placeholder="Equipo A">
<input id="teamB" placeholder="Equipo B">
</div>
</div>

<!-- ENCUENTRO -->
<div class="card">
<h3>Agregar Encuentro</h3>
<div class="grid">
<input id="competencia" placeholder="Competencia">
<select id="equipoLocal">
  <option value="">Local (general)</option>
  <option value="A">Equipo A es LOCAL</option>
  <option value="B">Equipo B es LOCAL</option>
</select>
  
<input id="ttA" placeholder="Tiros Totales A">
<input id="ttB" placeholder="Tiros Totales B">

<input id="tapA" placeholder="A Puerta A">
<input id="tapB" placeholder="A Puerta B">

<input id="corA" placeholder="Corners A">
<input id="corB" placeholder="Corners B">

<input id="tarA" placeholder="Tarjetas A">
<input id="tarB" placeholder="Tarjetas B">

<input id="golA" placeholder="Goles A">
<input id="golB" placeholder="Goles B">
</div>
<br>
<button onclick="addMatch()">A√ëADIR ENCUENTRO</button>
</div>

<!-- HISTORIAL -->
<div class="card">
<h3>Historial</h3>
<div id="historial"></div>
<table class="table" id="tabla">
<thead>
<tr>
<th>Partido</th>
<th>Competencia</th>
<th>TT (A|B)</th>
<th>AP (A|B)</th>
<th>COR (A|B)</th>
<th>TAR (A|B)</th>
<th>GOL (A|B)</th>
</tr>
</thead>
<tbody></tbody>
<tfoot>
<tr><th colspan="2">TOTAL</th>
<th id="t1"></th><th id="t2"></th><th id="t3"></th><th id="t4"></th><th id="t5"></th></tr>
<tr><th colspan="2">PROMEDIO</th>
<th id="p1"></th><th id="p2"></th><th id="p3"></th><th id="p4"></th><th id="p5"></th></tr>
<tr><th colspan="2">PROBABILIDAD</th>
<th id="pr1"></th><th id="pr2"></th><th id="pr3"></th><th id="pr4"></th><th id="pr5"></th></tr>
</tfoot>
</table>



</div>
<div class="card" style="text-align:left">
  <button onclick="irApuestas()">‚¨ÖÔ∏è Volver a Apuestas</button>
</div>
<div class="card" style="text-align:left">
  <button onclick="irEquipos()">üìä Analisis de equipos</button>
</div>
</div>
<script>  
// üî• Firebase  
const firebaseConfig = {  
  apiKey: "AIzaSyBtOk-otWrGU7ljda52yhVhSvQKaG3siRM",  
  authDomain: "apuestas-analisis.firebaseapp.com",  
  projectId: "apuestas-analisis",  
  storageBucket: "apuestas-analisis.firebasestorage.app",  
  messagingSenderId: "542021066839",  
  appId: "1:542021066839:web:bb6a43f578a39d07c68312"  
};  
firebase.initializeApp(firebaseConfig);  
const db = firebase.firestore();  
const ref = db.collection("equipos"); 
  
function overUnder(valorTotal, linea){  
  if (isNaN(valorTotal)) return "-";  
  return valorTotal > linea  
    ? OVER ${linea}  
    : UNDER ${linea};  
}  
  
// agregar encuentro  
  function normalizar(texto) {  
  if (!texto || typeof texto !== "string") return "";  
  
  return texto  
    .normalize("NFD")                  // quita acentos  
    .replace(/[\u0300-\u036f]/g, "")  
    .toLowerCase()  
    .trim();  
}  
  
async function addMatch() {  
  // ===============================  
  // 1Ô∏è‚É£ VALIDACIONES  
  // ===============================  
  const equipoA = teamA.value.trim();  
  const equipoB = teamB.value.trim();  
  
  if (!equipoA || !equipoB) {  
    alert("Debes ingresar ambos equipos");  
    return;  
  }  
  
  const campos = [  
    ttA, ttB, tapA, tapB,  
    corA, corB, tarA, tarB,  
    golA, golB  
  ];  
  
  for (let c of campos) {  
    if (c.value === "" || isNaN(c.value)) {  
      alert("Todos los campos num√©ricos deben estar completos");  
      return;  
    }  
  }  
  
  // ===============================  
  // 2Ô∏è‚É£ CREAR ENCUENTRO  
  // ===============================  
  const encuentro = {  
    competencia: competencia.value || "N/A",  
    local: equipoLocal.value || null,  
    stats: {  
      tt:  { A: Number(ttA.value),  B: Number(ttB.value)  },  
      tap: { A: Number(tapA.value), B: Number(tapB.value) },  
      cor: { A: Number(corA.value), B: Number(corB.value) },  
      tar: { A: Number(tarA.value), B: Number(tarB.value) },  
      gol: { A: Number(golA.value), B: Number(golB.value) }  
    }  
  };  
  
  // ===============================  
  // 3Ô∏è‚É£ BLOQUE DE GUARDADO (ESTE ES EL QUE FALTABA)  
  // ===============================  
  const q = await ref  
    .where("equipoA", "==", equipoA)  
    .where("equipoB", "==", equipoB)  
    .limit(1)  
    .get();  
  
  if (q.empty) {  
    await ref.add({  
      equipoA,  
      equipoB,  
        equipoA_norm: normalizar(equipoA),  
  equipoB_norm: normalizar(equipoB),  
      encuentros: [encuentro],  
      creado: firebase.firestore.FieldValue.serverTimestamp()  
    });  
  } else {  
    const doc = q.docs[0];  
    const data = doc.data();  
  
    const encuentros = Array.isArray(data.encuentros)  
      ? data.encuentros  
      : [];  
  
    await ref.doc(doc.id).update({  
      encuentros: [...encuentros, encuentro]  
    });  
  }  
  
  // ===============================  
  // 4Ô∏è‚É£ CONFIRMACI√ìN  
  // ===============================  
  alert("‚úÖ Encuentro guardado correctamente");  
}  
  
  function probOverUnder(encuentros, stat, linea){  
  let over = 0;  
  let under = 0;  
  
  encuentros.forEach(e => {  
    const s = e.stats;  
    const total = s[stat].A + s[stat].B;  
    if (total > linea) over++;  
    else under++;  
  });  
  
  const totalPartidos = encuentros.length || 1;  
  const pOver  = Math.round((over / totalPartidos) * 100);  
  const pUnder = Math.round((under / totalPartidos) * 100);  
  
  const pick   = pOver >= pUnder ? "OVER" : "UNDER";  
  const pct    = Math.max(pOver, pUnder);  
  
  let color = "red";  
  if (pct > 65) color = "green";  
  else if (pct >= 55) color = "yellow";  
  
  return `  
    <span class="prob ${color}">  
      ${pick} ${linea} (${pct}%)  
    </span>  
  `;  
}  
ref.onSnapshot(snapshot => {  
  const h = document.getElementById("historial");  
  h.innerHTML = "";  
  
  snapshot.forEach(doc => {  
    const m = doc.data();  
    if (!m.equipoA || !m.equipoB) {  
  console.warn("Documento inv√°lido:", m);  
  return;  
}  
  
const equipoAInput = teamA.value.trim();  
const equipoBInput = teamB.value.trim();  
  
  
// üëâ SOLO filtra si ambos inputs tienen valor  
if (equipoAInput && equipoBInput) {  
  const a1 = normalizar(m.equipoA);  
  const b1 = normalizar(m.equipoB);  
  const a2 = normalizar(equipoAInput);  
  const b2 = normalizar(equipoBInput);  
  
  const matchDirecto = a1 === a2 && b1 === b2;  
  const matchInvertido = a1 === b2 && b1 === a2;  
  
  if (!matchDirecto && !matchInvertido) return;  
}  
    const encuentros = m.encuentros || [];  
    const localElegido = document.getElementById("equipoLocal")?.value || null;  
      
  
// encuentros seg√∫n contexto  
const encuentrosContexto = localElegido  
  ? filtrarPorLocal(encuentros, localElegido)  
  : encuentros;  
  
// fallback inteligente  
const dataProb = encuentrosContexto.length >= 3  
  ? encuentrosContexto  
  : encuentros;  
  
    let tot = {  
      tt: 0, tap: 0, cor: 0, tar: 0, gol: 0  
    };  
let totA = { tt:0, tap:0, cor:0, tar:0, gol:0 };  
let totB = { tt:0, tap:0, cor:0, tar:0, gol:0 };  
    let filas = "";  
  
    encuentros.forEach(e => {  
      const s = e.stats;  
  
      tot.tt  += s.tt.A  + s.tt.B;  
      tot.tap += s.tap.A + s.tap.B;  
      tot.cor += s.cor.A + s.cor.B;  
      tot.tar += s.tar.A + s.tar.B;  
      tot.gol += s.gol.A + s.gol.B;  
// Equipo A  
totA.tt  += s.tt.A;  
totA.tap += s.tap.A;  
totA.cor += s.cor.A;  
totA.tar += s.tar.A;  
totA.gol += s.gol.A;  
  
// Equipo B  
totB.tt  += s.tt.B;  
totB.tap += s.tap.B;  
totB.cor += s.cor.B;  
totB.tar += s.tar.B;  
totB.gol += s.gol.B;  
            
      filas += `  
        <tr>  
          <td>${m.equipoA} vs ${m.equipoB}</td>  
          <td>${e.competencia}</td>  
          <td>${s.tt.A}|${s.tt.B}</td>  
          <td>${s.tap.A}|${s.tap.B}</td>  
          <td>${s.cor.A}|${s.cor.B}</td>  
          <td>${s.tar.A}|${s.tar.B}</td>  
          <td>${s.gol.A}|${s.gol.B}</td>  
        </tr>  
      `;  
    });  
  
    const n = encuentros.length || 1;  
const recomendaciones = generarRecomendaciones(dataProb);

const listaRecs = recomendaciones.map(r => `
  <li class="${r.top ? "top-pick" : ""}">
    ${r.top ? "üî• " : ""}${r.texto}
    <span class="confianza">${r.confianza}%</span>
  </li>
`).join("");


    h.innerHTML += `  
    <details class="card">  
      <summary>‚öΩ ${m.equipoA} vs ${m.equipoB} (${encuentros.length} encuentros)</summary>  
  
      <table class="table">  
        <thead>  
          <tr>  
            <th>Partido</th>  
            <th>Competencia</th>  
            <th>TT (A|B)</th>  
            <th>AP (A|B)</th>  
            <th>COR (A|B)</th>  
            <th>TAR (A|B)</th>  
            <th>GOL (A|B)</th>  
          </tr>  
        </thead>  
  
        <tbody>  
          ${filas}  
        </tbody>  
  
        <tfoot>  
          <tr>  
            <th colspan="2">TOTAL</th>  
            <th>${tot.tt}</th>  
            <th>${tot.tap}</th>  
            <th>${tot.cor}</th>  
            <th>${tot.tar}</th>  
            <th>${tot.gol}</th>  
          </tr>  
  
          <tr>  
            <th colspan="2">PROMEDIO</th>  
            <th>${(tot.tt/n).toFixed(1)}</th>  
            <th>${(tot.tap/n).toFixed(1)}</th>  
            <th>${(tot.cor/n).toFixed(1)}</th>  
            <th>${(tot.tar/n).toFixed(1)}</th>  
            <th>${(tot.gol/n).toFixed(1)}</th>  
          </tr>  
<tr>  
  <th colspan="2">PROM ${m.equipoA}</th>  
  <th>${(totA.tt/n).toFixed(1)}</th>  
  <th>${(totA.tap/n).toFixed(1)}</th>  
  <th>${(totA.cor/n).toFixed(1)}</th>  
  <th>${(totA.tar/n).toFixed(1)}</th>  
  <th>${(totA.gol/n).toFixed(1)}</th>  
</tr>  
<tr>  
  <th colspan="2">PROM ${m.equipoB}</th>  
  <th>${(totB.tt/n).toFixed(1)}</th>  
  <th>${(totB.tap/n).toFixed(1)}</th>  
  <th>${(totB.cor/n).toFixed(1)}</th>  
  <th>${(totB.tar/n).toFixed(1)}</th>  
  <th>${(totB.gol/n).toFixed(1)}</th>  
</tr>  
  
          <tr>  
  <td colspan="2"><b>PROBABILIDAD</b></td>  
<td>${probOverUnder(dataProb,"tt",24.5)}</td>  
<td>${probOverUnder(dataProb,"tap",5.5)}</td>  
<td>${probOverUnder(dataProb,"cor",7.5)}</td>  
<td>${probOverUnder(dataProb,"tar",2.5)}</td>  
<td>${probOverUnder(dataProb,"gol",2.5)}</td>  
  
  
</tr>  
  
        </tfoot>  
      </table>  
      <div class="recs">
  <h4>üß† Recomendaciones</h4>
  <ul>
    ${listaRecs}
  </ul>
</div>

    </details>`;  
  });  
 
  
  analizarFormaEquipos();  
});  
   
  
  function filtrarPorLocal(encuentros, local){  
  return encuentros.filter(e => e.local === local);  
}  
function irApuestas(){  
  window.location.href = "index.html";  
}  
function irEquipos(){  
  window.location.href = "buscador_api.html";  
}  
function analizarEquipo(partidos){  
  const tot = { tt:0, tap:0, cor:0, tar:0, gol:0 };  
  
  partidos.forEach(p=>{  
    tot.tt  += p.stats.tt;  
    tot.tap += p.stats.tap;  
    tot.cor += p.stats.cor;  
    tot.tar += p.stats.tar;  
    tot.gol += p.stats.gol;  
  });  
  
  const n = partidos.length || 1;  
  
  return {  
    prom: {  
      tt:(tot.tt/n).toFixed(1),  
      tap:(tot.tap/n).toFixed(1),  
      cor:(tot.cor/n).toFixed(1),  
      tar:(tot.tar/n).toFixed(1),  
      gol:(tot.gol/n).toFixed(1)  
    },  
    prob: {  
      tt:  probOverUnder(partidos.map(p=>({stats:{tt:{A:p.stats.tt,B:0}}})),"tt",20),  
      gol: probOverUnder(partidos.map(p=>({stats:{gol:{A:p.stats.gol,B:0}}})),"gol",2.5)  
    }  
  };  
}  
function analizarFormaEquipos(){  
  // Funci√≥n manual ‚Äì no depende de API ni liga  
  // Se deja para compatibilidad y futuras extensiones  
  
  const equipoA = teamA.value.trim();  
  const equipoB = teamB.value.trim();  
  
  if(!equipoA || !equipoB) return;  
  
  // Por ahora no hace c√°lculos extra  
  // Toda la l√≥gica ya se ejecuta en el onSnapshot  
  console.log("üìä Forma analizada (manual):", equipoA, "vs", equipoB);  
}  
  
function generarRecomendaciones(encuentros) {
  if (!Array.isArray(encuentros) || encuentros.length < 3) {
    return [{
      texto: "üìâ Datos insuficientes para recomendaciones",
      confianza: 0,
      top: true
    }];
  }

  const tot = { gol:0, cor:0, tar:0, tt:0 };

  encuentros.forEach(e => {
    tot.gol += e.stats.gol.A + e.stats.gol.B;
    tot.cor += e.stats.cor.A + e.stats.cor.B;
    tot.tar += e.stats.tar.A + e.stats.tar.B;
    tot.tt  += e.stats.tt.A  + e.stats.tt.B;
  });

  const n = encuentros.length;

  const avg = {
    gol: tot.gol / n,
    cor: tot.cor / n,
    tar: tot.tar / n,
    tt:  tot.tt  / n
  };

  const picks = [];

  function confianza(media, linea) {
    const diff = Math.abs(media - linea);
    return Math.min(95, Math.round(50 + diff * 20));
  }

  picks.push({
    texto: avg.gol >= 2.5 ? "‚öΩ Over 2.5 goles" : "‚öΩ Under 2.5 goles",
    confianza: confianza(avg.gol, 2.5)
  });

  picks.push({
    texto: avg.cor >= 9 ? "üö© Over 8.5 corners" : "üö© Under 8.5 corners",
    confianza: confianza(avg.cor, 8.5)
  });

  picks.push({
    texto: avg.tar >= 4 ? "üü® Over 3.5 tarjetas" : "üü® Under 3.5 tarjetas",
    confianza: confianza(avg.tar, 3.5)
  });

  picks.push({
    texto: avg.tt >= 20 ? "üéØ Over 19.5 tiros" : "üéØ Under 19.5 tiros",
    confianza: confianza(avg.tt, 19.5)
  });

  // üî• ordenar por confianza
  picks.sort((a,b) => b.confianza - a.confianza);

  // üî• marcar la mejor
  picks[0].top = true;

  return picks;
}

</script>

</body>
</html>
